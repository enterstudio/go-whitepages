# This references the default golang container from
# the Docker Hub: https://registry.hub.docker.com/u/library/golang/
# If you want Google's container you would reference google/golang
# Read more about containers on our dev center
# http://devcenter.wercker.com/docs/containers/index.html
box: golang
# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# http://devcenter.wercker.com/docs/pipelines/index.html

# You can also use services such as databases. Read more on our dev center:
# http://devcenter.wercker.com/docs/services/index.html
# services:
    # - postgres
    # http://devcenter.wercker.com/docs/services/postgresql.html

    # - mongodb
    # http://devcenter.wercker.com/docs/services/mongodb.html
build:
  # The steps that will be executed on build
  # Steps make up the actions in your pipeline
  # Read more about steps on our dev center:
  # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    # Sets the go workspace and places you package
    # at the right place in the workspace tree
    # - wercker/golint
    - setup-go-workspace

    # setup
    - script:
        name: setup
        code: |
          go get github.com/tools/godep
    - script:
        name: go build
        code: |
          godep go build ./...

    # Test the project
    - script:
        name: go test
        code: |
          godep go test ./...          
       
       
box: golang:1.5-wheezy
services:
    - redis
    - rethinkdb

# This Pipeline is responsible for linting, and testing
# the data-service.
build:
  steps:
    - wercker/golint
    - wercker/setup-go-workspace:
        package-dir: github.com/the-control-group/data-service-api
    - script:
        name: setup
        code: |
          go get github.com/tools/godep
          go get github.com/smartystreets/goconvey
    - script:
        name: go test
        code: |
          export REDIS_HOST=$REDIS_PORT_6379_TCP_ADDR:$REDIS_PORT_6379_TCP_PORT
          export DATA_CONFIG=$WERCKER_SOURCE_DIR/example-conf
          export RETHINK_HOST=$RETHINKDB_PORT_28015_TCP_ADDR:$RETHINKDB_PORT_28015_TCP_PORT
          godep go test -v ./...
    - script:
        name: build app
        code: |
          export GIT_SHORT_HASH=`git rev-parse --short HEAD`
          godep go build -ldflags "-X main.version=$GIT_SHORT_HASH" -o bin/data-service main.go
          echo Packaging Binaries...
          mkdir -p tmp/data-service/bin
          cp -R bin scripts tmp/data-service/
          echo $WERCKER_GIT_COMMIT > tmp/data-service/scripts/regression/commit_hash.txt
          tar -cvzf $WERCKER_OUTPUT_DIR/data-service.tar.gz -C tmp data-service;
          rm -rf tmp
deploy:
  steps:
    - chrismckenzie/rackspace-cloud-files-upload@0.0.1:
        username: $RACKSPACE_USER
        token: $RACKSPACE_TOKEN
        region: IAD
        container: data-service
        path: $BUILD_PATH/data-service.tar.gz
        file_path: $WERCKER_ROOT/data-service.tar.gz
        content_type: application/x-gzip
